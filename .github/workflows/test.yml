name: Run Cross-platform Tests

on:
  - push
  - pull_request

jobs:
  lint:
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    name: Lint the Code
    steps:
      - uses: actions/checkout@master
      - name: Lint JavaScript
        run: |
          npm install -g standard
          standard
      - name: Lint Python
        run: |
          pip install pycodestyle
          pycodestyle
  test-in-matrix:
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          # - windows-latest
        python:
          - 3.7
          - 3.8
        ipfs:
          - 0.4
          - 0.5
    runs-on: ${{ matrix.os }}
    name: Test on ${{ matrix.os }} Py ${{ matrix.python }} IPFS ${{ matrix.ipfs }}
    steps:
      - uses: actions/checkout@master
      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@master
        with:
          python-version: ${{ matrix.python }}
      - name: Set up IPFS ${{ matrix.ipfs }}
        uses: ibnesayeed/setup-ipfs@master
        with:
          ipfs_version: ${{ matrix.ipfs }}
      - name: Install Dependencies
        shell: bash
        run: |
          pip install -r requirements.txt
          pip install -r test-requirements.txt
      - name: Boot IPFS Daemon
        shell: bash
        run: |
          ipfs daemon &
          while ! curl -s localhost:5001 > /dev/null; do sleep 1; done
      - name: Run Tests
        shell: bash
        run: py.test -s --cov=./
  test-in-container:
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    name: Test in Docker Container
    steps:
      - uses: actions/checkout@master
      - name: Build Image and Test
        run: docker image build .
